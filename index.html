<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SkillSwap</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <img src="logo.png" alt="SkillSwap Logo" />
    <h1>SkillSwap</h1>
    <button id="logout-btn" class="hidden">Logout</button>
  </header>

  <main>
    <!-- Auth -->
    <section id="auth-section">
      <h2>Login oder Registrieren</h2>
      <input type="email" id="email" placeholder="Email" required>
      <input type="password" id="password" placeholder="Passwort" required>
      <button id="login-btn">Login / Registrieren</button>
    </section>

    <!-- Profil -->
    <section id="profile-section" class="hidden">
      <h2>Dein Profil</h2>
      <input id="name" placeholder="Name">
      <input id="age" type="number" placeholder="Alter">
      <input id="location" placeholder="Ort">
      <input id="skills" placeholder="Talente (z.B. Mathe, Klavier)">
      <input id="avatar_url" placeholder="Bild-URL (optional)">
      <button id="save-profile-btn">Profil speichern</button>
    </section>

    <!-- Suche -->
    <section id="search-section" class="hidden">
      <h2>Suche nach Talenten</h2>
      <input id="search-skill" placeholder="z.B. Mathe">
      <button id="search-btn">Suchen</button>
      <div id="results"></div>
    </section>
  </main>

  <!-- Supabase SDK muss VOR script.js geladen werden -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.2/dist/umd/supabase.min.js"></script>

  <!-- Dein Script: wird geladen, wenn alles fertig ist -->
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const supabase = window.supabase.createClient(
        "https://your-project.supabase.co", // <-- Deine Supabase URL
        "your-anon-key"                    // <-- Dein Supabase Anon Key
      );

      // Deine komplette JS-Logik hier rein (oder lade script.js hier)
      window.supabaseClient = supabase;

      const email = document.getElementById("email");
      const password = document.getElementById("password");
      const loginBtn = document.getElementById("login-btn");
      const logoutBtn = document.getElementById("logout-btn");

      const authSection = document.getElementById("auth-section");
      const profileSection = document.getElementById("profile-section");
      const searchSection = document.getElementById("search-section");

      const nameInput = document.getElementById("name");
      const ageInput = document.getElementById("age");
      const locationInput = document.getElementById("location");
      const skillsInput = document.getElementById("skills");
      const avatarInput = document.getElementById("avatar_url");

      const saveBtn = document.getElementById("save-profile-btn");
      const searchBtn = document.getElementById("search-btn");
      const searchInput = document.getElementById("search-skill");
      const resultsDiv = document.getElementById("results");

      loginBtn.addEventListener("click", async () => {
        const { error } = await supabase.auth.signInWithPassword({
          email: email.value,
          password: password.value,
        });

        if (error) {
          const { error: signupError } = await supabase.auth.signUp({
            email: email.value,
            password: password.value,
          });
          if (signupError) alert("Fehler bei Registrierung: " + signupError.message);
        }

        checkAuth();
      });

      logoutBtn.addEventListener("click", async () => {
        await supabase.auth.signOut();
        location.reload();
      });

      saveBtn.addEventListener("click", async () => {
        const user = (await supabase.auth.getUser()).data.user;
        if (!user) return;

        const { error } = await supabase.from("profiles").upsert({
          id: user.id,
          name: nameInput.value,
          age: parseInt(ageInput.value),
          location: locationInput.value,
          skills: skillsInput.value.split(",").map(s => s.trim()),
          avatar_url: avatarInput.value || "https://via.placeholder.com/80"
        });

        if (error) {
          alert("Fehler beim Speichern: " + error.message);
        } else {
          alert("Profil gespeichert!");
        }
      });

      searchBtn.addEventListener("click", async () => {
        const searchTerm = searchInput.value.toLowerCase();
        const { data, error } = await supabase
          .from("profiles")
          .select("*")
          .contains("skills", [searchTerm]);

        resultsDiv.innerHTML = "";
        if (error) {
          resultsDiv.textContent = "Fehler bei der Suche.";
          return;
        }

        data.forEach(profile => {
          const card = document.createElement("div");
          card.className = "profile-card";
          card.innerHTML = `
            <img src="${profile.avatar_url || "https://via.placeholder.com/80"}" alt="Avatar">
            <div>
              <h3>${profile.name}</h3>
              <p>Alter: ${profile.age || "-"}</p>
              <p>Ort: ${profile.location || "-"}</p>
              <p>Talente: ${profile.skills?.join(", ")}</p>
            </div>
          `;
          resultsDiv.appendChild(card);
        });
      });

      async function checkAuth() {
        const { data } = await supabase.auth.getSession();
        const user = data.session?.user;

        if (user) {
          authSection.classList.add("hidden");
          profileSection.classList.remove("hidden");
          searchSection.classList.remove("hidden");
          logoutBtn.classList.remove("hidden");
        }
      }

      checkAuth();
    });
  </script>
</body>
</html>
